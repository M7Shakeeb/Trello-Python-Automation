name: Dockerized Python Tests

on: [push, pull_request]

jobs:
  docker-test-run:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Build Docker Image
      run: docker build -t trello-python-tests .

    - name: Create Test Results Folder
      run: mkdir -p test-results

    # Run Tests in Docker with Volume Mount
    - name: Run Tests in Docker with Volume Mount
      # FIX: We must define the env variables FOR THIS STEP explicitly
      env:
        TRELLO_KEY: ${{ secrets.TRELLO_KEY }}
        TRELLO_TOKEN: ${{ secrets.TRELLO_TOKEN }}
      run: |
        docker run --rm \
        -v ${{ github.workspace }}/test-results:/app/test-results \
        -e TRELLO_KEY="$TRELLO_KEY" \
        -e TRELLO_TOKEN="$TRELLO_TOKEN" \
        trello-python-tests \
        pytest --html=test-results/report.html

    # Upload the Report as an Artifact
    - name: Upload Test Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Docker-Test-Report
        path: test-results/report.html